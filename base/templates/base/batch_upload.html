{% extends 'main.html' %}
{% load static %}

{% block content %}
<div class="container mt-4">
    <div class="card">
        <div class="card-header bg-primary text-white">
            <h3 class="mb-0"><i class="bi bi-upload me-2"></i>Batch Upload</h3>
        </div>
        
        <div class="card-body">
            <form method="post" enctype="multipart/form-data" class="needs-validation" novalidate>
                {% csrf_token %}
                
                <!-- Upload Type Selection -->
                <div class="mb-4">
                    <h5 class="mb-3 text-muted">1. Select Upload Type</h5>
                    <div class="form-group">
                        {{ form.upload_type.label_tag }}
                        {{ form.upload_type }}
                        <small class="form-text text-muted">
                            Choose what type of data you're uploading
                        </small>
                    </div>
                </div>
                
                <!-- Session and Level Selection -->
                <div class="mb-4">
                    <h5 class="mb-3 text-muted">2. Set Parameters</h5>
                    <div class="row g-3">
                        <div class="col-md-6">
                            <div class="form-group">
                                {{ form.session.label_tag }}
                                {{ form.session }}
                                <small class="form-text text-muted">
                                    Select target session for all records
                                </small>
                            </div>
                        </div>
                        <div class="col-md-6" id="levelField" style="display:none">
                            <div class="form-group">
                                {{ form.level.label_tag }}
                                {{ form.level }}
                                <small class="form-text text-muted">
                                    Required for candidates, optional for stations
                                </small>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- File Upload -->
                <div class="mb-4">
                    <h5 class="mb-3 text-muted">3. Upload File</h5>
                    <div class="form-group">
                        {{ form.csv_file.label_tag }}
                        {{ form.csv_file }}
                        <div class="alert alert-info mt-2">
                            <strong>Required format:</strong>
                            <div id="formatHint" class="mt-1 font-monospace">
                                station_name,description,max_score
                            </div>
                            <small class="d-block mt-1">
                                First row should be headers. File must be UTF-8 encoded CSV.
                            </small>
                        </div>
                    </div>
                </div>
                
                <!-- Form Actions -->
                <div class="d-flex justify-content-between align-items-center mt-4">
                    <a href="{% static 'sample_files/batch_upload_samples.zip' %}" 
                       class="btn btn-outline-secondary">
                        <i class="bi bi-file-earmark-arrow-down me-2"></i>
                        Download Samples
                    </a>
                    
                    <button type="submit" class="btn btn-primary px-4">
                        <i class="bi bi-upload me-2"></i>
                        Upload File
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Dynamic Help Script -->
<script>
document.addEventListener('DOMContentLoaded', function() {
    const uploadType = document.getElementById('id_upload_type');
    const formatHints = {
        'candidates': 'matric_number,full_name,passport_file (optional)',
        'stations': 'name,description',
        'activities': 'station_name,description,max_score',
        'combined': 'station_name,station_description,activity_description,activity_max_score'
    };
    
    const levelRequirements = {
        'candidates': 'Required - Sets level for all candidates in file',
        'stations': 'Optional - Leave blank for stations available to all levels',
        'activities': 'Not used - Activities inherit station levels',
        'combined': 'Optional - Sets level for all created stations'
    };
    
    function updateFormatHint() {
        const selectedType = uploadType.value;
        document.getElementById('formatHint').textContent = formatHints[selectedType];
        
        // Toggle level field
        const levelField = document.getElementById('levelField');
        levelField.style.display = selectedType !== 'activities' ? 'block' : 'none';
        
        // Update level help text
        if (levelField.querySelector('.form-text')) {
            levelField.querySelector('.form-text').textContent = levelRequirements[selectedType];
        }
    }
    
    uploadType.addEventListener('change', updateFormatHint);
    updateFormatHint(); // Initialize on load
});
</script>

<style>
.font-monospace {
        font-family: monospace;
        background-color: #f8f9fa;
        padding: 0.2rem 0.4rem;
        border-radius: 3px;
    }
.card-header {
        padding: 1rem 1.5rem;
    }
.form-group {
        margin-bottom: 1.5rem;
    }

    /* Remove gray backgrounds and improve form styling */
.card-body {
    background-color: white; /* Ensures white background */
    padding: 2rem;
}

.form-control, .form-select {
    background-color: white !important; /* Force white input backgrounds */
    border: 1px solid #dee2e6; /* Clean border */
}

.form-text.text-muted {
    color: #6c757d !important; /* Better muted text color */
}

/* Improved spacing and focus states */
.form-group {
    margin-bottom: 1.25rem;
}

.form-control:focus, .form-select:focus {
    border-color: #86b7fe;
    box-shadow: 0 0 0 0.25rem rgba(13, 110, 253, 0.25);
}

/* File upload styling */
#id_csv_file {
    padding: 0.5rem;
}

/* Sample format hint box */
.font-monospace {
    background-color: #f8f9fa; /* Light gray only for code hints */
    padding: 0.5rem;
    border-radius: 4px;
    display: inline-block;
    margin: 0.25rem 0;
}

</style>
{% endblock %}